---
title: "Musicology"
output: 
  flexdashboard::flex_dashboard:
runtime: shiny
---

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(tidyverse)
library(spotifyr) 
library(ggplot2)
library(hrbrthemes)
library(compmus)


playlist <- get_playlist_audio_features('', '2EUygq17yMPzSbM6XTm4rs') 
playlist$release <- as.Date(playlist$track.album.release_date, format = "%Y-%m-%d")


```

```{r}
# Reactive that returns the whole dataset if there is no brush
selectedData <- reactive({
  data <- brushedPoints(playlist, input$plot_brush)
  if (nrow(data) == 0)
    data <- playlist
  data
})
```

# Introduction

## Column {data-width="650"}

### Raw data {data-width="600"}

```{r}
ggplot(playlist, aes(x=release, y=tempo)) +
 geom_point()
```

### Data processing

above you see a quick overview of the release date of the tracks in my playlist together with the tempo. One thing to note here is that the tempo of a lot of tracks is wrong. My guess is that spotify thinks the tempo is half of what it should actually be, since the tempo of tracks in my playlist should actually range between 140-200+.

This together with some of the outliers made before 2015 makes the graph look messy. so i decided to remove every entry from before 2015, and multiply every tempo that is lower than 135 by 2, which made the data a lot cleaner as you will see on the Interactive plot page

## Column {data-width="350"}

### Info {data-width="400"}

Fill in when finished, give info about where to see what

# Interactive plot

```{r include=FALSE}
specified_date <- as.Date("2015-01-01")
playlist <- playlist[playlist$release >= specified_date,]

playlist <- playlist[complete.cases(playlist$tempo), ]
playlist$tempo[playlist$tempo < 135] <- playlist$tempo[playlist$tempo < 135] * 2

playlist <- playlist[, c('track.name', 'tempo', 'energy', 'danceability', 'release')]
```

## Column {data-width="650"}

### Tempo vs release date (try selecting some tracks) {data-width="600"}

```{r}

renderPlot({
  ggplot(playlist, aes(x=release, y=tempo)) + geom_point()
}, outputArgs = list(brush = brushOpts(id = "plot_brush")))
```

### tempo vs energy vs danceability

```{r}
renderPlot({
  ggplot(selectedData(), aes(x=energy, y=tempo, color=danceability)) + 
    geom_point() +
    geom_smooth(method="lm", formula= (y ~ exp(2*x)), se=FALSE, color='red') +
    scale_color_gradient(low = "blue", high = "yellow")
})
```

## Column {data-width="350"}

### Selected tracks {data-width="400"}

```{r}
renderTable({
  selectedData()
})
```


Chroma Features {data-orientation=rows}
===================================== 
```{R}
wood <-
  get_tidy_audio_analysis("38KNGUbQYgeLrOCgUK8vyx") |>
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )
```



Row {data-height=600} {data-orientation=columns}
-------------------------------------

### chromatograph {data-width="650"}

```{r}
wood |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme(aspect.ratio=9/16, legend.position="bottom") +
  scale_fill_viridis_c()

```

### info {data-width="350"}
you can see that the B, F and C are the most common notes being played. At around 3 minutes there is an increase in B, which you can also hear in the track itself, my guess is that the higher magnitute is because of the so called "kickdrum" being played at the drop of the track, and at around 3 minutes you can hear that it stays pitched the same for a bit. \ 
 

below you can also see two self similarity matrixes, one for timbre and one for chroma. for me the chroma chart looks especially interesting because of the two distinct lines ytou see running through the graph.

Row {data-height=400}
-------------------------------------
   
### timbre

```{r}

wood |>
  compmus_self_similarity(timbre, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```
 
    
### pitches

```{r}
wood |>
  compmus_self_similarity(pitches, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```
